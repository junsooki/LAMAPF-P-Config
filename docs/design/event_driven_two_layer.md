# Event-driven: Two-Layer Time-Expanded Flow (Empty/Loaded)

## 目标
在单轮重规划时刻 `t0`，一次网络流把每个机器人规划到“下一目标点”：
- 空载机器人 -> 取货点
- 满载机器人 -> 卸货点

该方案适配 event-driven：每次有机器人到达目标后触发下一轮重规划。

## 可行性与必要约束
### 1) 空载/满载分层
- 空载机器人只能从 `E` 层出发并到达取货点的 gate。
- 满载机器人只能从 `L` 层出发并到达卸货点的 gate。
- 本轮只规划到“下一目标点”，所以不需要 `E -> L` 的状态转换边。

### 2) 点冲突（跨层共享容量）
你提出的 `occ(v,t)` 共享容量=1 是必要的：
- 能阻止 `E` 层与 `L` 层在同一时刻占用同一格。

### 3) 边冲突（跨层共享容量）
仅有点容量仍允许“对向交换”导致边冲突。
必须加 **边容量**（edge-time 节点或边占用门）：
- 对每条无向边 `(u,v)` 和时间 `t` 建 `edge(u,v,t)`，容量=1。
- 无论是 `E` 层还是 `L` 层，凡是从 `u@t -> v@t+1` 或 `v@t -> u@t+1` 的移动，都必须经过同一个 `edge(u,v,t)` 节点。
这样可以禁止同一时间在同一条边上逆向交换。

## 卸货点吸收机制（服务台容量 < agent 数）
若服务台只限制“同一时刻最多 1 人”，则不应使用“总容量 gate”（会把服务台变成一次性资源）。
推荐改为 **按时间吸收**：
- 对每个卸货点 `d`、每个时间层 `t`，直接连 `(d^L_t -> T)`，容量=1。
- 不再设置“每个服务台跨时间总容量”的 gate。

这样服务台可被不同机器人在不同时间重复使用，且“同一时刻最多 1 人”仍由点容量保证。

## 任务出现时间（spawn time）
任务是“货物实例”，应当按 **(位置, 出现时间)** 管理：
- 只能从 `t >= spawn_time` 的时间层进入该任务的 gate。
- 任务被 pick 后，从下一轮开始移除（不再可选）。

## 结论
- 该建图可以作为 event-driven 的“单轮 next-goal 规划”。
- 关键补充：**边冲突容量** + **任务出现时间过滤**。
- 若卸货点容量仅限制“同时占用”，请使用“按时间吸收”的机制，避免总容量 gate 造成错误不可行。
- 该模型不保证全局最优，但可与 event-driven 反复重规划配合使用。
